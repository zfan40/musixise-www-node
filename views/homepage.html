<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>musixise</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <!-- Normalize CSS  -->
    <link rel="stylesheet" href="/styles/mainpage/common.min.css">
    <!-- Link Swiper's CSS -->
    <link rel="stylesheet" href="/styles/mainpage/swiper.min.css">
    <!-- Demo styles -->
    <!-- <link href='https://fonts.googleapis.com/css?family=Dancing+Script' rel='stylesheet' type='text/css'> -->
    <div style="display:none">
        <script src="http://s95.cnzz.com/z_stat.php?id=1260048285&web_id=1260048285" language="JavaScript"></script>
    </div>
    <script>
!(function(c,b,d,a){c[a]||(c[a]={});c[a].config={pid:"dxmqpaf3oh@9f10bfa6ec38562",imgUrl:"https://arms-retcode.aliyuncs.com/r.png?",enableSPA:true};
with(b)with(body)with(insertBefore(createElement("script"),firstChild))setAttribute("crossorigin","",src=d)
})(window,document,"https://retcode.alicdn.com/retcode/bl.js","__bl");
</script>
    <!-- JQuery JS -->
    <script src="/scripts/jquery.js"></script>
    <!-- JQuery JS -->
    <script src="/scripts/jquery.ui.widget.js"></script>
    <!-- JQuery Upload -->
    <script src="/scripts/blueimp-upload.js"></script>
    <style>
    html,
    body {
        position: relative;
        height: 100%;
    }

    body {
        background: #eee;
        font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
        font-size: 14px;
        color: #000;
        margin: 0;
        padding: 0;
    }

    input:focus,
    select:focus,
    textarea:focus,
    button:focus {
        outline: none;
    }

    #header {
        width: 100%;
        position: fixed;
    }

    #header .logo {
        background-color: #ffcc33;
    }

    .swiper-container {
        width: 100%;
        height: 100%;
        margin-left: auto;
        margin-right: auto;
        background: #000;
    }

    .swiper-slide {
        text-align: center;
        font-size: 18px;
        /* Center slide text vertically */
        display: -webkit-box;
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
        -webkit-box-pack: center;
        -ms-flex-pack: center;
        -webkit-justify-content: center;
        justify-content: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        -webkit-align-items: center;
        align-items: center;
    }

    .swiper-slide img {
        /*max-width: 100%;*/
        width: 1280px;
    }

    .swiper-slide>p {
        position: absolute;
        color: #aaa;
        top: 45%;
        transform: translate(0%, -50%);
        font-size: 48px;
        width: 600px;
        padding-bottom: 100px;
        transition-duration: 1000ms;
    }

    .swiper-slide>p>r {
        font-size: 32px;
    }

    .swiper-slide .left {
        left: 40px;
        font-family: 'Dancing Script', cursive;
    }

    .swiper-slide .right {
        right: 40px;
        font-family: 'Dancing Script', cursive;
    }

    .popup {
        background-color: rgba(255, 255, 255, 0.98);
        border-radius: 5px;
        position: fixed;
        top: 201px;
        left: 50%;
        transform: translate(-50%, 0%);
        z-index: 100;
        text-align: center;
    }

    .popup .caption {
        text-align: center;
        display:flex;
        align-items:stretch;
        flex-direction:column;
        font-size: 40px;
        /*line-height: 104px;*/
        height: 104px;
        /*color:rgba(27, 80, 90, 0.5);*/
        /*color:#39797D;*/
        color: #000;

    }
    .popup .caption .caption1 {
        flex:2;
        display: flex;
        align-items:center;
    }
    .popup .caption .caption2{
        flex:1;
        display: flex;
        /*align-items:center;*/
    }
    .popup .caption .caption1 p{
        flex:1;
    }
    .popup .caption .caption2 p{
        flex:1;
        font-size: 12px;
    }

    .popup input {
        display: inline-block;
        height: 40px;
        width: 220px;
        font-size: 16px;
        line-height: 32px;
        /*margin-bottom: 32px;*/
        border-radius: 3px;
        border: none;
        padding: 0 10px;
        border: 1px solid #000;
        color: #000;
        background-color: rgba(255, 255, 255, 0.98);
    }

    .popup button {
        cursor: pointer;
        display: inline-block;
        height: 40px;
        width: 220px;
        font-size: 16px;
        line-height: 32px;
        border-radius: 3px;
        border: none;
        /*background: linear-gradient(to right, rgba(27, 80, 90, 0.5), rgba(78, 20, 89, 0.5));*/
        /*background-color:#39797D;*/
        background-color: #000;
        color: #fff;
    }

    #reg-popup {
        width: 290px;
        padding-bottom: 30px;
    }

    #login-popup {
        width: 290px;
        padding-bottom: 30px;
    }

    .mask {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 999;
        background: rgba(0, 0, 0, .8);
        display: none;
        color: #000;
        -webkit-box-orient: horizontal;
        -webkit-box-pack: center;
        -webkit-box-align: center;
    }

    ::-webkit-input-placeholder {
        color: #000;
    }

    :-moz-placeholder {
        /* Firefox 18- */
        color: #000;
    }

    ::-moz-placeholder {
        /* Firefox 19+ */
        color: #000;
    }

    :-ms-input-placeholder {
        color: #000;
    }

    #user-avatar {
        width: 50px;
        position: relative;
        height: 50px;
        top: -15px;
    }

    #user-avatar img {
        width: 50px;
        height: 50px;
    }
    </style>
</head>

<body>
    <div id="header">
        <div class="header-inner">
            <div class="logo" style="background-image:url('/imgs/mainpage/logo.png')">
                <a href=""></a>
            </div>
            <div class="log">
                <ul class="log-menu">
                    <!-- <li><a class="username">小f</a></li> -->
                    <!-- <li><a class="im" href="###" id="im_notify">消息<sup style="display: none;">●</sup></a></li> -->
                    <li id="reg-anchor" style="display:none;"><a>注册</a></li>
                    <li id="login-anchor" style="display:none;"><a>登陆</a></li>
                    <li id="stage-anchor" style="display:none;"><a>开始表演</a></li>
                    <li id="update-anchor" style="display:none;"><a>更新头像</a></li>
                    <li id="logout-anchor" style="display:none"><a class="logout">登出</a></li>
                    <li id="user-avatar" style="display:none"><img src=""></li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Swiper -->
    <div class="swiper-container">
        <div class="swiper-wrapper">
            <div class="swiper-slide">
                <img src="/imgs/mainpage/1.jpg">
                <p class="left" id="quote0">Music comes straight from the heart and talks only to the heart.
                    <br> --
                    <r>Sergei Rachmaninoff</r>
                </p>
            </div>
            <div class="swiper-slide">
                <img src="/imgs/mainpage/6.jpg">
                <p class="left" id="quote1">Music is not a hobby, not even a passion with me; music is me.
                    <br> --
                    <r>Arthor Rubinstein</r>
                </p>
            </div>
            <div class="swiper-slide">
                <img src="/imgs/mainpage/3.jpg">
                <p class="right" id="quote2">Perfection itself is imperfection.
                    <br> --
                    <r>Vladimir Horowitz</r>
                </p>
            </div>
            <div class="swiper-slide">
                <img src="/imgs/mainpage/4.jpg">
                <p class="right" id="quote3">Music must be given to those who love it. I want to give free concerts; that's the answer.
                    <br> --
                    <r>Sviataslav Richter</r>
                </p>
            </div>
            <div class="swiper-slide">
                <img src="/imgs/mainpage/4.jpg">
                <div id="footer">京ICP备16027182号</div>
            </div>
            <!--             <div class="swiper-slide">
                <img src="/imgs/mainpage/4.jpg">
                <p class="right" id="quote3">Music must be given to those who love it. I want to give free concerts; that's the answer. </p>
            </div>  -->
        </div>
        <!-- Add Pagination -->
        <div class="swiper-pagination"></div>
    </div>
    <div class="mask">
        <div class="popup" id="reg-popup" style="display:none;">
            <div class="caption">
                <div class="caption1">
                    <p>加入稀客</p>
                </div>
            </div>
            <div>
                <input placeholder="账号名(字母及数字)" type="text" id="reg-username"></input>
                <p style="height:20px;line-height:18px;color:red;padding:6px 24px"></p>
                <input placeholder="艺名(展示)" type="text" id="reg-realname"></input>
                <p style="height:20px;line-height:18px;color:red;padding:6px 24px"></p>
                <input placeholder="密码" type="password" id="reg-password"></input>
                <p style="height:20px;line-height:18px;color:red;padding:6px 24px"></p>
                <form style="display:none;" id="register-by-wechat" method="post" action="/z/register/wechat">
                    <input type="submit" value="微信注册" >
                </form>
                <form style="display:none;" id="register-by-weibo" method="post" action="/z/register/weibo">
                    <input type="submit" value="微博注册" >
                </form>
                <form style="display:none;" id="register-by-qq" method="post" action="/z/register/qq">
                    <input type="submit" value="QQ注册" >
                </form>
                <button id="reg-btn">注册</button>
            </div>
        </div>
        <div class="popup" id="login-popup" style="display:none;">
            <div class="caption">
                <div class="caption1">
                    <p>欢迎回来</p>
                </div>
                <div class="caption2">
                    <p>暂不支持第三方账号登录</p>
                </div>
            </div>
            <div>
                <input placeholder="用户名" type="text" id="login-username"></input>
                <p style="height:20px;line-height:20px;color:red;padding:10px 24px"></p>
                <input placeholder="密码" type="password" id="login-password"></input>
                <p style="height:20px;line-height:20px;color:red;padding:10px 24px"></p>
                <form style="display:none;" id="signin-by-wechat" method="post" action="/z/signin/wechat">
                    <input type="submit" value="微信登录" >
                </form>
                <form style="display:none;" id="signin-by-weibo" method="post" action="/z/signin/weibo">
                    <input type="submit" value="微博登录" >
                </form>
                <form style="display:none;" id="signin-by-qq" method="post" action="/z/signin/qq">
                    <input type="submit" value="QQ登录" >
                </form>

                <button id="login-btn">登陆</button>
            </div>
        </div>
        <div class="popup" id="upload-popup" style="display:none;">
            <div class="caption">
                <p>更新头像(请上传正方形图片)</p>
            </div>
            <div>
                <!-- <input id="fileupload" type="file" name="files[]" multiple=""> -->
                <input id="fileupload" type="file" name="files">
            </div>
        </div>
    </div>
    <!-- Swiper JS -->
    <script src="/scripts/mainpage/swiper.min.js"></script>
    <!-- Initialize Swiper -->
    <script>
    function getCookie(name) {
        var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
        if (arr = document.cookie.match(reg)) {
            return arr[2];
        } else {
            return null;
        }
    }

    function setCookie(name, value, days) {
        var cookieString = name + "=" + value;
        if (days > 0) {
            var date = new Date();
            date.setTime(date.getTime() + days * 24 * 3600 * 1000);
            cookieString = cookieString + "; expires=" + date.toGMTString() + ';domain=.musixise.com;path=/';
        }
        document.cookie = cookieString;
    }

    function deleteCookie(name) {
        document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;domain=.musixise.com;path=/';
    }

    function statusInit() {
        if (getCookie('access_token')) { //previous info stored in cookie
            $('#stage-anchor').show();
            $('#update-anchor').show();
            $('#logout-anchor').show();
            $('#user-avatar img').attr('src', getCookie('user_avatar'));
            $('#user-avatar').show();
            $.ajax({    //check whether token expired,and also update info
                url: "//api.musixise.com/api/user/getInfo",
                type: 'POST',
                data: {},
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("Access-Control-Allow-Origin",'*');
                    xhr.setRequestHeader("Authorization", "Bearer " + getCookie('access_token'));
                    xhr.setRequestHeader("Accept", "application/json");
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                success: function(data, status) {
                    console.log(data);
                    setCookie('uid',data.data.userId,31);
                    setCookie('realname',data.data.realname,31);
                    var avatar = data.data.largeAvatar
                    if (avatar) {
                        setCookie('user_avatar', avatar, 31);
                        $('#user-avatar img').attr('src', avatar);
                        $('#user-avatar').show();
                    }
                    $('#stage-anchor').show();
                    $('#update-anchor').show();
                    $('#logout-anchor').show();
                    $('#user-avatar img').attr('src', getCookie('user_avatar'));
                    $('#user-avatar').show();
                },
                error: function() {
                    deleteCookie('dotcom_user');
                    deleteCookie('access_token');
                    deleteCookie('user_avatar');
                    deleteCookie('realname');
                    $('#login-anchor').show();
                    $('#reg-anchor').show();
                }
            });

        } else {
            $('#login-anchor').show();
            $('#reg-anchor').show();
        }
    }

    var swiper = new Swiper('.swiper-container', {
        pagination: '.swiper-pagination',
        direction: 'vertical',
        slidesPerView: 1,
        paginationClickable: true,
        spaceBetween: 30,
        mousewheelControl: true,
        keyboardControl: true,
        onInit: function() {
            document.querySelector('#quote0').style.paddingBottom = '0px';
        },
        onSlideChangeStart: function(swiper) {
                if (document.querySelector('#quote' + swiper.activeIndex))
                    document.querySelector('#quote' + swiper.activeIndex).style.paddingBottom = '0px';
                if (document.querySelector('#quote' + (swiper.activeIndex - 1)))
                    document.querySelector('#quote' + (swiper.activeIndex - 1)).style.paddingBottom = '150px';
                if (document.querySelector('#quote' + (swiper.activeIndex + 1)))
                    document.querySelector('#quote' + (swiper.activeIndex + 1)).style.paddingBottom = '150px';
            }
            // onSliderMove: function(swiper,evt) {
            // console.log(swiper);pageY,screenY,y,off\setY,movementY,layerY
            // console.log(evt.layerY);
            // }
            // lazyLoadingInPrevNext:true
    });
    statusInit();
    bindPopReg();
    bindPopLogin();
    bindUploadAvatar();
    bindHideMask();
    bindUserInfo();

    //注册弹框
    function bindPopReg() {
        document.querySelector('#reg-anchor').addEventListener('click', function() {
            document.querySelector('.mask').style.display = 'block';
            [].forEach.call(document.querySelectorAll('.popup'), function(ele) {
                ele.style.display = 'none'
            });
            document.querySelector('#reg-popup').style.display = 'block';
        });
    }

    //登录弹框
    function bindPopLogin() {
        document.querySelector('#login-anchor').addEventListener('click', function() {
            document.querySelector('.mask').style.display = 'block';
            [].forEach.call(document.querySelectorAll('.popup'), function(ele) {
                ele.style.display = 'none'
            });
            document.querySelector('#login-popup').style.display = 'block';
        });
    }

    //上传头像
    function bindUploadAvatar() {
        var url = '//api.musixise.com/api/picture/uploadPic';
        $("#update-anchor").click(function() {
            $('.mask').show();
            $('.popup').hide();
            $('#upload-popup').show();
        });
        $('#fileupload').fileupload({
                url: url,
                dataType: 'json',
                type: 'POST',
                done: function(e, data) {
                    var avatarUrl = 'http://' + 'oaeyej2ty.bkt.clouddn.com/' + data.result.data;
                    setCookie('user_avatar', avatarUrl, 31);
                    $('#user-avatar img').attr('src', avatarUrl);
                    $('#user-avatar').show();
                    $('.mask').hide();
                    $('.popup').hide();

                    //更新用户信息（头像）
                    $.ajax({
                        url: "//api.musixise.com/api/user/updateInfo",
                        beforeSend: function(xhr, settings) {
                            xhr.setRequestHeader("Access-Control-Allow-Origin",'*');
                            xhr.setRequestHeader("Authorization", "Bearer " + getCookie('access_token'));
                            xhr.setRequestHeader("Accept", "application/json");
                            xhr.setRequestHeader("Content-Type", "application/json");
                        },
                        data: JSON.stringify({
                            largeAvatar:data.result.data,
                            smallAvatar:data.result.data
                        }),
                        type: 'POST',
                        success: function(res) {
                            console.log(res);
                            if (!res.errcode) {

                            } else {
                                alert(res.errmsg);
                            }
                        },
                        error: function() {
                            alert('更新用户信息（头像）失败鸟...');
                            return;
                        }
                    });
                },
                progressall: function(e, data) {
                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    // $('#progress .progress-bar').css(
                    //     'width',
                    //     progress + '%'
                    // );
                }
            }).prop('disabled', !$.support.fileInput)
            .parent().addClass($.support.fileInput ? undefined : 'disabled');
    }

    //Mask 隐藏
    function bindHideMask() {
        document.querySelector('.mask').addEventListener('click', function(e) {
            if (e.target.className == 'mask') {
                document.querySelector('.mask').style.display = 'none';
                [].forEach.call(document.querySelectorAll('.popup'), function(ele) {
                    ele.style.display = 'none'
                });
            }
        });
    }

    //登陆
    function bindUserInfo() {
        $('#login-btn').click(function() {
            var loginInfo = {
                username: $('#login-username').val(),
                password: $('#login-password').val()
            }
            $.ajax({
                url: "//api.musixise.com/api/user/authenticate",
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("Access-Control-Allow-Origin",'*');
                    xhr.setRequestHeader("Accept", "application/json");
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                data: JSON.stringify(loginInfo),
                type: 'POST',
                success: function(res) {
                    console.log(res);
                    if (!res.errcode) {
                        alert("登陆成功");
                        setCookie('dotcom_user', loginInfo.username, 31);
                        setCookie('access_token', res.id_token, 31);

                        $('#login-anchor').hide();
                        $('#reg-anchor').hide();
                        $('#stage-anchor').show();
                        $('#logout-anchor').show();
                        $('#update-anchor').show();
                        $.ajax({
                            url: "//api.musixise.com/api/user/getInfo",
                            type: 'POST',
                            data: {},
                            beforeSend: function(xhr, settings) {
                                xhr.setRequestHeader("Access-Control-Allow-Origin",'*');
                                xhr.setRequestHeader("Authorization", "Bearer " + res.id_token);
                                xhr.setRequestHeader("Accept", "application/json");
                                xhr.setRequestHeader("Content-Type", "application/json");
                            },
                            success: function(data, status) {
                                console.log(data);
                                setCookie('uid',data.data.userId,31);
                                setCookie('realname',data.data.realname,31);
                                var avatar = data.data.largeAvatar
                                if (avatar) {
                                    setCookie('user_avatar', avatar, 31);

                                    $('#user-avatar img').attr('src', avatar);
                                    $('#user-avatar').show();
                                }
                            },
                            error: function() {
                                //shouldn't get error, since just succesfully get token, and use that to retrieve info. TODO: authenticate should return user info directly.not another interface.
                            }
                        });
                        $('.mask').click();
                    } else {
                        alert(res.errmsg);
                    }
                },
                error: function() {
                    alert('账号信息有误请重试');
                    return;
                }
            })
        });

        //注册
        $('#reg-btn').click(function() {
            var loginInfo = {
                username: $('#reg-username').val(),
                password: $('#reg-password').val(),
                realname: $('#reg-realname').val(),
                //后台必须要email，但是注册没有text填，所以先写死
                email: Math.random().toString().slice(2, 12) + '@gmail.com'
            }
            $.ajax({
                url: "//api.musixise.com/api/user/register",
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("Access-Control-Allow-Origin",'*');
                    xhr.setRequestHeader("Accept", "application/json");
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                data: JSON.stringify(loginInfo),
                type: 'POST',
                success: function(res) {
                    console.log(res);
                    if (!res.errcode) {
                        alert("账号注册成功,请前往登陆");
                        $('.mask').click();
                    } else {
                        if (res.errmsg) {
                            alert(res.errmsg);
                        } else {
                            alert("账号注册失败，请稍后再试");
                        }
                    }
                },
                error: function() {
                    alert("账号注册失败，请稍后再试");
                }
            })
        });

        //表演
        $('#stage-anchor').click(function() {
                var uid = getCookie('uid');
                if (uid) {
                    location.href = '//' + location.host + '/stage/' + uid;
                } else {
                    location.reload();
                }
            })
            //登出
        $('#logout-anchor').click(function() {
            deleteCookie('dotcom_user');
            deleteCookie('access_token');
            deleteCookie('user_avatar');
            deleteCookie('realname');
            location.reload();
        })
    }
    </script>
</body>

</html>
